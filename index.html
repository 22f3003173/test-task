<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brief Builder - Test Brief</title>
  <meta name="description" content="Create, preview, and export concise project briefs with autogenerated evaluation checklists." />
  <style>
    :root{
      --bg: #0b0d12;
      --panel: #121722;
      --text: #e7ecf2;
      --muted: #a8b3c2;
      --accent: #7dd3fc;
      --accent-2: #a78bfa;
      --ok: #34d399;
      --warn: #fbbf24;
      --danger: #f87171;
      --border: #263042;
      --focus: #2dd4bf;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg: #f6f8fc;
      --panel: #ffffff;
      --text: #101623;
      --muted: #4a5568;
      --accent: #2563eb;
      --accent-2: #7c3aed;
      --ok: #059669;
      --warn: #d97706;
      --danger: #dc2626;
      --border: #e5e7eb;
      --focus: #0ea5e9;
      --shadow: 0 8px 24px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol;
      background: linear-gradient(180deg, var(--bg), color-mix(in oklab, var(--bg), #000 6%));
      color: var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      background: color-mix(in oklab, var(--panel), var(--bg) 30%);
      border-bottom:1px solid var(--border);
      backdrop-filter: saturate(1.1) blur(10px);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .bar{
      display:flex;align-items:center;gap:12px;justify-content:space-between;
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.2px
    }
    .logo{
      width:28px;height:28px;border-radius:8px;
      background: conic-gradient(from 210deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--panel), var(--accent) 15%), 0 6px 18px rgba(0,0,0,.2);
    }
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    button, .btn{
      appearance:none;border:1px solid var(--border);background: color-mix(in oklab, var(--panel), var(--bg) 15%);
      color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;
      transition:.15s transform ease, .2s background ease, .2s border ease;
    }
    button:hover, .btn:hover{transform: translateY(-1px);background: color-mix(in oklab, var(--panel), var(--bg) 5%)}
    button:active, .btn:active{transform: translateY(0)}
    .primary{border-color: color-mix(in oklab, var(--accent), var(--border) 60%); background: color-mix(in oklab, var(--panel), var(--accent) 12%)}
    .danger{border-color: color-mix(in oklab, var(--danger), var(--border) 50%); background: color-mix(in oklab, var(--panel), var(--danger) 10%)}
    .ok{border-color: color-mix(in oklab, var(--ok), var(--border) 50%); background: color-mix(in oklab, var(--panel), var(--ok) 10%)}
    .warn{border-color: color-mix(in oklab, var(--warn), var(--border) 50%); background: color-mix(in oklab, var(--panel), var(--warn) 10%)}
    .grid{
      display:grid;grid-template-columns: 1fr 1fr;gap:16px;align-items:stretch;
      max-width:1200px;margin:16px auto;padding:0 16px 24px;
    }
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      background: var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow: var(--shadow);overflow:hidden;
      display:flex;flex-direction:column;min-height:360px;
    }
    .card header{position:relative;top:auto;background:transparent;border:0;backdrop-filter:none}
    .card-title{
      display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);
    }
    .body{padding:16px;display:flex;flex-direction:column;gap:12px;flex:1;min-height:260px}
    label{font-weight:700;font-size:.9rem}
    .muted{color:var(--muted);font-weight:500}
    input[type="text"], textarea, select{
      width:100%;border:1px solid var(--border);background: color-mix(in oklab, var(--panel), var(--bg) 12%);
      color:var(--text);padding:10px 12px;border-radius:10px;outline:none;transition:.15s border ease;
      font-size:.98rem
    }
    textarea{min-height:96px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color: var(--focus); box-shadow: 0 0 0 3px color-mix(in oklab, var(--focus), transparent 75%)}
    .row{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    .help{font-size:.85rem;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background: color-mix(in oklab, var(--panel), var(--bg) 10%);font-weight:700;font-size:.85rem;color:var(--muted)
    }
    .pill .dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
    .footer{
      display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 16px;border-top:1px solid var(--border);background: color-mix(in oklab, var(--panel), var(--bg) 10%);
    }
    .preview{
      padding:10px 12px;background: color-mix(in oklab, var(--panel), #000 4%);border-radius:12px;border:1px dashed var(--border);overflow:auto;flex:1
    }
    .preview h1,.preview h2,.preview h3{margin:.2rem 0 .4rem 0}
    .preview ul{margin:.2rem 0 .8rem 1.2rem}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: color-mix(in oklab, var(--panel), var(--bg) 20%);border:1px solid var(--border);padding:2px 6px;border-radius:6px;font-size:.85rem
    }
    .switch{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background: color-mix(in oklab, var(--panel), var(--bg) 10%);cursor:pointer;
    }
    .switch input{display:none}
    .switch .knob{
      width:34px;height:18px;border-radius:99px;background: color-mix(in oklab, var(--panel), var(--bg) 20%);border:1px solid var(--border);position:relative
    }
    .switch .knob::after{
      content:"";position:absolute;top:50%;left:2px;transform:translateY(-50%);width:14px;height:14px;border-radius:50%;background: var(--accent);transition:.2s left ease, .2s background ease
    }
    .switch input:checked + .knob::after{left:18px;background: var(--ok)}
    .tiny{font-size:.8rem;color:var(--muted)}
    .statusbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .counter{margin-left:auto}
    .toast{
      position:fixed;right:16px;bottom:16px;background: var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow: var(--shadow);opacity:0;transform: translateY(8px);pointer-events:none;transition:.2s opacity ease,.2s transform ease
    }
    .toast.show{opacity:1;transform: translateY(0)}
    .sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <div class="brand" aria-label="App brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          Brief Builder
          <div class="tiny">Round 1 â€¢ Test brief</div>
        </div>
      </div>
      <div class="actions">
        <label class="switch" title="Toggle light/dark theme">
          <input id="themeToggle" type="checkbox" aria-label="Toggle theme">
          <span class="knob" aria-hidden="true"></span>
          <span>Light</span>
        </label>
        <button id="shareBtn" class="btn" title="Create a shareable link">Share link</button>
        <button id="copyMdBtn" class="btn primary" title="Copy Markdown (Ctrl/Cmd+B)">Copy Markdown</button>
        <button id="downloadBtn" class="btn ok" title="Download Markdown file">Download</button>
        <button id="resetBtn" class="btn danger" title="Clear all fields">Reset</button>
      </div>
    </div>
  </header>

  <main class="grid" id="app">
    <section class="card" aria-labelledby="editor-title">
      <div class="card-title">
        <div>
          <div id="editor-title" class="pill"><span class="dot" aria-hidden="true"></span> Brief editor</div>
          <div class="tiny">Autosaves locally. Fields accept multiple lines as separate items.</div>
        </div>
        <div class="statusbar">
          <span class="kbd" title="Save">Ctrl/Cmd+S</span>
          <span class="kbd" title="Copy Markdown">Ctrl/Cmd+B</span>
        </div>
      </div>
      <div class="body">
        <div class="row">
          <div>
            <label for="name">Project name</label>
            <input id="name" type="text" placeholder="e.g., Test Brief App" />
            <div class="help">Keep it concise and descriptive.</div>
          </div>
          <div>
            <label for="round">Round</label>
            <select id="round">
              <option value="1" selected>1</option>
              <option value="2">2</option>
            </select>
            <div class="help">If you are iterating, set Round 2 to track improvements.</div>
          </div>
        </div>

        <div>
          <label for="overview">Overview</label>
          <textarea id="overview" placeholder="What problem does this solve? Target users? Why now?"></textarea>
          <div class="help"><span id="overviewCount" class="muted">0</span> characters</div>
        </div>

        <div class="row">
          <div>
            <label for="goals">Goals</label>
            <textarea id="goals" placeholder="One goal per line"></textarea>
            <div class="help">Tip: Start lines with verbs (Ship, Reduce, Improve...).</div>
          </div>
          <div>
            <label for="features">Features</label>
            <textarea id="features" placeholder="One feature per line"></textarea>
            <div class="help">We'll auto-generate evaluation checks for these.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="constraints">Constraints</label>
            <textarea id="constraints" placeholder="One constraint per line"></textarea>
          </div>
          <div>
            <label for="metrics">Success metrics</label>
            <textarea id="metrics" placeholder="One metric per line (quantify when possible)"></textarea>
          </div>
        </div>

        <div>
          <label for="notes">Notes / Risks</label>
          <textarea id="notes" placeholder="Dependencies, open questions, risks, trade-offs"></textarea>
        </div>

        <div class="row">
          <div>
            <label for="attachments">Attachments (URLs)</label>
            <textarea id="attachments" placeholder="One URL per line"></textarea>
          </div>
          <div>
            <label for="improvements">Round 2 improvements</label>
            <textarea id="improvements" placeholder="If Round = 2, list the improvements from the previous version"></textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="style">Checklist style</label>
            <select id="style">
              <option value="checkbox" selected>Checkboxes [ ]</option>
              <option value="bullets">Bullets â€¢</option>
              <option value="numbers">Numbered 1.</option>
            </select>
          </div>
          <div>
            <label for="slug">File slug</label>
            <input id="slug" type="text" placeholder="test-brief" />
            <div class="help">Used for downloads. Keep lowercase, hyphen-separated.</div>
          </div>
        </div>

        <div>
          <input class="sr-only" type="file" id="importFile" accept="application/json" />
          <div class="actions">
            <button id="exportJsonBtn" class="btn" title="Export .json of your brief">Export JSON</button>
            <button id="importJsonBtn" class="btn" title="Import a previously exported .json">Import JSON</button>
          </div>
        </div>
      </div>
      <div class="footer">
        <span class="muted">Local status: <strong id="saveStatus">Saved</strong></span>
        <span class="muted counter">Words: <strong id="wordCount">0</strong></span>
      </div>
    </section>

    <section class="card" aria-labelledby="preview-title">
      <div class="card-title">
        <div id="preview-title" class="pill"><span class="dot" style="background:var(--accent-2)"></span> README preview</div>
        <div>
          <button id="toggleRawBtn" class="btn" title="View raw Markdown preview">Raw MD</button>
        </div>
      </div>
      <div class="body">
        <div id="preview" class="preview" role="document" aria-label="Brief preview" tabindex="0"></div>
      </div>
      <div class="footer">
        <span class="muted">Generated Markdown preview</span>
        <div class="actions">
          <button id="copyMdBtn2" class="btn primary">Copy Markdown</button>
          <button id="downloadBtn2" class="btn ok">Download</button>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // Utilities
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const STORAGE_KEY = 'briefBuilderDataV1';
    const THEME_KEY = 'briefBuilderTheme';

    const b64EncodeUnicode = str =>
      btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (_, p1) => String.fromCharCode('0x' + p1)));
    const b64DecodeUnicode = str =>
      decodeURIComponent(Array.prototype.map.call(atob(str), c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));

    const debounce = (fn, delay=250) => {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
    };

    const toast = (msg) => {
      const node = $('#toast'); node.textContent = msg; node.classList.add('show');
      setTimeout(()=> node.classList.remove('show'), 1800);
    };

    const defaultData = {
      name: 'Test Brief App',
      round: '1',
      overview: 'A simple, self-contained web app to build, preview, and export concise project briefs. Includes autosave, theme toggle, and shareable links.',
      goals: [
        'Produce a complete single-file web app',
        'Provide README preview and export',
        'Offer autosave and share links',
        'Ensure accessibility and responsive layout'
      ],
      features: [
        'Live Markdown preview of the brief',
        'Autosave to localStorage',
        'Light/Dark theme toggle',
        'Export/Import JSON',
        'Shareable link via URL hash',
        'Copy/Download Markdown output'
      ],
      constraints: [
        'No external dependencies',
        'Single HTML file deliverable',
        'Works offline'
      ],
      metrics: [
        'Loads under 1 second on modern devices',
        'Lighthouse Performance >= 90',
        'Zero console errors'
      ],
      notes: 'This is a test brief. Edit any field to see live updates.',
      attachments: [],
      improvements: '',
      style: 'checkbox',
      slug: 'test-brief'
    };

    // State
    let state = { ...defaultData };

    // Elements
    const els = {
      name: $('#name'),
      round: $('#round'),
      overview: $('#overview'),
      goals: $('#goals'),
      features: $('#features'),
      constraints: $('#constraints'),
      metrics: $('#metrics'),
      notes: $('#notes'),
      attachments: $('#attachments'),
      improvements: $('#improvements'),
      style: $('#style'),
      slug: $('#slug'),
      saveStatus: $('#saveStatus'),
      wordCount: $('#wordCount'),
      overviewCount: $('#overviewCount'),
      preview: $('#preview'),
      themeToggle: $('#themeToggle'),
      shareBtn: $('#shareBtn'),
      resetBtn: $('#resetBtn'),
      copyMdBtn: $('#copyMdBtn'),
      copyMdBtn2: $('#copyMdBtn2'),
      downloadBtn: $('#downloadBtn'),
      downloadBtn2: $('#downloadBtn2'),
      exportJsonBtn: $('#exportJsonBtn'),
      importJsonBtn: $('#importJsonBtn'),
      importFile: $('#importFile'),
      toggleRawBtn: $('#toggleRawBtn'),
    };

    // Theme
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      els.themeToggle.checked = theme === 'light';
      try { localStorage.setItem(THEME_KEY, theme); } catch {}
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      applyTheme(saved || (prefersLight ? 'light':'dark'));
    }
    els.themeToggle.addEventListener('change', () => {
      applyTheme(els.themeToggle.checked ? 'light' : 'dark');
    });

    // Helpers
    const linesFromTextarea = (str) => (str || '')
      .split(/\r?\n/)
      .map(s => s.trim())
      .filter(Boolean);

    const toTextareaValue = (arr) => (arr || []).join('\n');

    const formatChecklist = (items, style) => {
      if (!items?.length) return '';
      if (style === 'checkbox'){
        return items.map(i => `- [ ] ${i}`).join('\n');
      } else if (style === 'numbers'){
        return items.map((i, idx) => `${idx+1}. ${i}`).join('\n');
      }
      return items.map(i => `- ${i}`).join('\n');
    };

    const sanitizeSlug = (s) => (s || '')
      .toLowerCase()
      .replace(/[^a-z0-9\-]+/g, '-')
      .replace(/\-+/g, '-')
      .replace(/^\-|\-$/g, '') || 'brief';

    // Markdown generation
    function generateEvaluationChecks(features){
      return (features || []).map(f => `Verify "${f}" works as described:
  - [ ] Functionality behaves correctly
  - [ ] Usability meets expectations
  - [ ] Edge cases handled
  - [ ] No console errors`);
    }

    function toMarkdown(data){
      const {
        name, round, overview, goals, features, constraints, metrics, notes, attachments, improvements, style
      } = data;

      const checks = generateEvaluationChecks(features);
      const md = [
        `# ${name || 'Untitled Project'}`,
        '',
        '## Overview',
        overview?.trim() || '_No overview provided._',
        '',
        '## Goals',
        goals?.length ? formatChecklist(goals, style) : '_No goals provided._',
        '',
        '## Features',
        features?.length ? formatChecklist(features, style) : '_No features provided._',
        '',
        '## Constraints',
        constraints?.length ? formatChecklist(constraints, style) : '_No constraints provided._',
        '',
        '## Success Metrics',
        metrics?.length ? formatChecklist(metrics, style) : '_No metrics provided._',
        '',
        '## Notes / Risks',
        notes?.trim() ? notes.trim() : '_No additional notes._',
        '',
        '## Evaluation checks',
        checks.length ? checks.map((c, i) => `### Feature ${i+1}\n${c}`).join('\n\n') : '_No evaluation checks generated._',
        '',
        attachments?.length ? '## Attachments\n' + attachments.map(a => `- ${a}`).join('\n') : '',
        '',
        round === '2' && improvements?.trim() ? '## Round 2 improvements\n' + improvements.trim() : ''
      ].filter(Boolean).join('\n');
      return md;
    }

    // Simple Markdown rendering (subset)
    function mdToHtml(md){
      let html = md
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); // escape
      html = html
        .replace(/^### (.*)$/gim, '<h3>$1</h3>')
        .replace(/^## (.*)$/gim, '<h2>$1</h2>')
        .replace(/^# (.*)$/gim, '<h1>$1</h1>')
        .replace(/^\- \[ \] (.*)$/gim, '<li><input type="checkbox" aria-label="check item"> $1</li>')
        .replace(/^\- (.*)$/gim, '<li>$1</li>')
        .replace(/^\d+\. (.*)$/gim, '<li>$1</li>')
        .replace(/\n{2,}/g, '\n\n');

      // Wrap list items with <ul> or <ol> heuristically
      const lines = html.split('\n');
      let out = [];
      let inUl = false, inOl = false;

      const openUl = ()=>{ out.push('<ul>'); inUl = true; };
      const closeUl = ()=>{ out.push('</ul>'); inUl = false; };
      const openOl = ()=>{ out.push('<ol>'); inOl = true; };
      const closeOl = ()=>{ out.push('</ol>'); inOl = false; };

      for (let line of lines){
        if (/^<li>/.test(line)){
          if (!inUl && !inOl){ openUl(); }
          out.push(line);
        } else if (/^\s*$/.test(line)) {
          if (inUl){ closeUl(); }
          if (inOl){ closeOl(); }
          out.push('');
        } else if (/^<h[1-6]>/.test(line)){
          if (inUl){ closeUl(); }
          if (inOl){ closeOl(); }
          out.push(line);
        } else {
          if (inUl){ closeUl(); }
          if (inOl){ closeOl(); }
          // paragraphs
          if (line.trim()){
            out.push(`<p>${line}</p>`);
          } else {
            out.push('');
          }
        }
      }
      if (inUl) closeUl();
      if (inOl) closeOl();

      // Checkboxes styling
      return out.join('\n');
    }

    // Render
    let showRaw = false;
    function render(){
      els.saveStatus.textContent = 'Saved';
      const md = toMarkdown(state);
      const html = showRaw ? `<pre class="mono" style="white-space:pre-wrap">${md.replace(/</g,'&lt;')}</pre>` : mdToHtml(md);
      els.preview.innerHTML = html;
      // counts
      const wordCount = [
        state.name,
        state.overview,
        ...state.goals,
        ...state.features,
        ...state.constraints,
        ...state.metrics,
        state.notes,
        ...state.attachments,
        state.improvements
      ].join(' ').trim().split(/\s+/).filter(Boolean).length;
      els.wordCount.textContent = wordCount;
      els.overviewCount.textContent = (state.overview || '').length;
    }

    const save = debounce(() => {
      els.saveStatus.textContent = 'Savingâ€¦';
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        els.saveStatus.textContent = 'Saved';
      } catch (e) {
        els.saveStatus.textContent = 'Save failed';
        console.error(e);
      }
      render();
    }, 250);

    // Bind form -> state
    function bind(){
      els.name.addEventListener('input', e => { state.name = e.target.value; save(); });
      els.round.addEventListener('change', e => { state.round = e.target.value; save(); });
      els.overview.addEventListener('input', e => { state.overview = e.target.value; save(); });

      els.goals.addEventListener('input', e => { state.goals = linesFromTextarea(e.target.value); save(); });
      els.features.addEventListener('input', e => { state.features = linesFromTextarea(e.target.value); save(); });
      els.constraints.addEventListener('input', e => { state.constraints = linesFromTextarea(e.target.value); save(); });
      els.metrics.addEventListener('input', e => { state.metrics = linesFromTextarea(e.target.value); save(); });
      els.notes.addEventListener('input', e => { state.notes = e.target.value; save(); });
      els.attachments.addEventListener('input', e => { state.attachments = linesFromTextarea(e.target.value); save(); });
      els.improvements.addEventListener('input', e => { state.improvements = e.target.value; save(); });
      els.style.addEventListener('change', e => { state.style = e.target.value; save(); });
      els.slug.addEventListener('input', e => { state.slug = sanitizeSlug(e.target.value); e.target.value = state.slug; save(); });

      // Buttons
      els.resetBtn.addEventListener('click', () => {
        if (!confirm('Clear all fields and reset to template?')) return;
        state = { ...defaultData };
        populateForm();
        save();
        toast('Reset to template');
      });

      const copyMd = async () => {
        try {
          const md = toMarkdown(state);
          await navigator.clipboard.writeText(md);
          toast('Markdown copied');
        } catch {
          toast('Copy failed');
        }
      };
      els.copyMdBtn.addEventListener('click', copyMd);
      els.copyMdBtn2.addEventListener('click', copyMd);

      const download = () => {
        const md = toMarkdown(state);
        const blob = new Blob([md], {type: 'text/markdown;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${sanitizeSlug(state.slug || state.name || 'brief')}.md`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast('Download started');
      };
      els.downloadBtn.addEventListener('click', download);
      els.downloadBtn2.addEventListener('click', download);

      els.exportJsonBtn.addEventListener('click', () => {
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], {type: 'application/json;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${sanitizeSlug(state.slug || state.name || 'brief')}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        toast('Exported JSON');
      });

      els.importJsonBtn.addEventListener('click', () => els.importFile.click());
      els.importFile.addEventListener('change', async (e) => {
        const file = e.target.files?.[0]; if (!file) return;
        try{
          const text = await file.text();
          const data = JSON.parse(text);
          state = { ...state, ...data };
          populateForm();
          save();
          toast('Imported JSON');
        } catch (err){
          console.error(err);
          toast('Import failed');
        } finally {
          e.target.value = '';
        }
      });

      els.shareBtn.addEventListener('click', async () => {
        try {
          const compact = JSON.stringify(state);
          const encoded = b64EncodeUnicode(compact);
          const url = `${location.origin}${location.pathname}#d=${encoded}`;
          await navigator.clipboard.writeText(url);
          history.replaceState(null, '', `#d=${encoded}`);
          toast('Shareable link copied');
        } catch (e){
          console.error(e);
          toast('Share failed');
        }
      });

      els.toggleRawBtn.addEventListener('click', () => {
        showRaw = !showRaw;
        els.toggleRawBtn.textContent = showRaw ? 'Rendered' : 'Raw MD';
        render();
      });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        const isMac = navigator.platform.toUpperCase().includes('MAC');
        const mod = isMac ? e.metaKey : e.ctrlKey;
        if (mod && e.key.toLowerCase() === 's'){
          e.preventDefault();
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); toast('Saved'); } catch {}
        }
        if (mod && e.key.toLowerCase() === 'b'){
          e.preventDefault();
          els.copyMdBtn.click();
        }
      });
    }

    function populateForm(){
      els.name.value = state.name || '';
      els.round.value = state.round || '1';
      els.overview.value = state.overview || '';
      els.goals.value = toTextareaValue(state.goals);
      els.features.value = toTextareaValue(state.features);
      els.constraints.value = toTextareaValue(state.constraints);
      els.metrics.value = toTextareaValue(state.metrics);
      els.notes.value = state.notes || '';
      els.attachments.value = toTextareaValue(state.attachments);
      els.improvements.value = state.improvements || '';
      els.style.value = state.style || 'checkbox';
      els.slug.value = state.slug || sanitizeSlug(state.name || 'brief');
      render();
    }

    function loadFromStorage(){
      try {
        const hash = location.hash;
        if (hash.startsWith('#d=')){
          const encoded = hash.slice(3);
          const json = b64DecodeUnicode(encoded);
          const data = JSON.parse(json);
          state = { ...state, ...data };
          toast('Loaded from link');
          return;
        }
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw){
          const data = JSON.parse(raw);
          state = { ...state, ...data };
          return;
        }
      } catch (e){
        console.warn('Failed to load saved state', e);
      }
    }

    // Init
    initTheme();
    loadFromStorage();
    bind();
    populateForm();

    // Accessibility: announce dynamic updates
    const observer = new MutationObserver(debounce(() => {
      $('#preview').setAttribute('aria-busy', 'false');
    }, 150));
    $('#preview').setAttribute('aria-busy', 'true');
    observer.observe($('#preview'), { childList: true, subtree: true });

  </script>
</body>
</html>